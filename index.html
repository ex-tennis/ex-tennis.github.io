<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Brache</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js"></script>
<style>


body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }


	.mapboxgl-popup {
max-width: 400px;
font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
padding-top: -20px;
}

.marker {
background-size: cover;
cursor: pointer;
#-webkit-transform-origin: 0px 0px;
#-moz-transform-origin: 0px 0px;
#-ms-transform-origin: 0px 0px;
#-o-transform-origin: 0px 0px;
#transform-origin: 0px 0px;
#-webkit-transform: rotate(30deg);
#-moz-transform: rotate(30deg);
#-ms-transform: rotate(30deg);
#-o-transform: rotate(30deg);
#transform: rotate(30deg);
}



.button2{
	position: absolute;
	top: -10%;
	left: -10%;
	display:block;
	cursor: pointer;
	width:120%;
	height:120%;
	border:0.5em solid #FFFFFF;
	border-radius:0.5em;
	box-sizing: border-box;
    background: transparent;
    font-size:0;
}
.button-div{
}

</style>
</head>
<body>

<div id="map"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibHVpc2UtaGFldXNlciIsImEiOiJja2d3MHEybHQwNW5pMzBycm9rOXFndzV0In0.0DUrtkqAOlmHkX8BXtixmw';
var items = {
'type': 'geojson',
'data': https://luisevonderwiese.github.io/brache/items.geo.json
}

var map = new mapboxgl.Map({
container: 'map',
style: 'mapbox://styles/luise-haeuser/cktemen6q2gba17s0txukk39c', 
center: [8.349325060844421, 49.01890053442718], 
zoom: 18.5,
maxZoom: 19,
minZoom: 18
});

map.addControl(
new mapboxgl.GeolocateControl({
positionOptions: {
enableHighAccuracy: true
},
// When active the map will receive updates to the device's location as it changes.
trackUserLocation: true,
// Draw an arrow next to the location dot to indicate which direction the device is heading.
showUserHeading: true
})
);






map.on('load', () => {

map.addSource('route', {
'type': 'geojson',
'data':https://luisevonderwiese.github.io/brache/route.geo.json 
});


map.addSource('border', {
'type': 'geojson',
'data': 'https://luisevonderwiese.github.io/brache/areal.geo.json'
});

 

map.addLayer({
'id': 'outline',
'type': 'line',
'source': 'border',
'layout': {},
'paint': {
'line-color': '#000',
'line-width': 1
}
});

map.addLayer({
'id': 'r',
'type': 'line',
'source': 'route',
'layout': {},
'paint': {
'line-color': '#8B0000',
'line-width': 5
//line-opacity
}});

var i = 0
items.data.features.forEach(function (marker) {
	if(visibleNow(marker)){
		if(map.getSource('area_' + i) == undefined && marker.properties.area != undefined) {
			map.addSource('area_' + i, marker.properties.area);
			map.addLayer({
				'id': 'area_' + i,
				'type': 'line',
				'source': 'area_' + i,
				'layout': {},
				'paint': {
					'line-color': '#000',
					'line-width': 1
				}});
		}
		i++;
	}
});
console.log(map.getSource("area_0")); 
console.log(map.getSource("border")); 
});



function visibleNow(marker) {
	const today = new Date();
	let parts = marker.properties.begin.split('-');
	const begin = new Date(parts[0], parts[1]-1, parts[2], parts[3], parts[4]);
	parts = marker.properties.end.split('-');
	const end = new Date(parts[0], parts[1]-1, parts[2], parts[3], parts[4]);
	parts = marker.properties.begin_daily.split('-');
	const begin_daily = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parts[0], parts[1]);
    parts = marker.properties.end_daily.split('-');
	const end_daily = new Date(today.getFullYear(), today.getMonth(), today.getDate(), parts[0], parts[1]);
	if(today.getTime() < begin.getTime() || today.getTime() > end.getTime()) {
		return false;
	}
	if(today.getTime() < begin_daily.getTime() || today.getTime() > end_daily.getTime()) {
		return false;
	}
	return true;
}
items.data.features.forEach(function (marker) {
	if(visibleNow(marker)){
	    var el = document.createElement('div');
        el.className = 'marker';
		el.style.width = marker.properties.iconSize[0] + 'px';
        el.style.height = marker.properties.iconSize[1] + 'px';
		el.style.backgroundImage = 'url(\'' + marker.properties.icon + '\')';
		deg = 90;
		
		/*el.style.webkitTransform = 'rtate('+deg+'deg)'; 
		el.style.mozTransform = 'rtate('+deg+'deg)'; 
		el.style.msTransform = 'rtate('+deg+'deg)'; 
		el.style.oTransform = 'rtate('+ deg+'deg)'; 
		el.style.transform = 'rtate('+ deg+'deg)';
		
		el.style['transform'] = 'rotate(30deg)';

		el.style['-ms-transform'] = 'rotate(30deg)'; // IE
		el.style['-moz-transform'] = 'rotate(30deg)'; // Firefox
		el.style['-webkit-transform'] = 'rotate(30deg)'; // Chrome
		el.style['-o-transform'] = 'rotate(30deg)'; // Opera*/
	
		

		var popup = new mapboxgl.Popup({ offset: marker.properties.iconSize[1]/2 + 2 }).setHTML(
			marker.properties.description + '<div/>'
		);
 
 
		new mapboxgl.Marker(el)
		.setLngLat(marker.geometry.coordinates)
		.setPopup(popup) // sets a popup on this marker
		.addTo(map);
		

	}
		

    });

class MyCustomControl {
  onAdd(map){
    this.map = map;
    this.container = document.createElement('div');
	this.container.style.backgroundSize = 'cover';
	this.container.style.backgroundImage = 'url(https://image.flaticon.com/icons/png/512/128/128223.png)';
	this.container.style.width = '25px';
	this.container.style.height = '25px';
    this.container.style.margin = '1em 1em 0em 0em';
    this.container.className = 'mapboxgl-ctrl';
    const button = this._createButton('button2')
    this.container.appendChild(button);
    return this.container;
  }
  onRemove(){
    this.container.parentNode.removeChild(this.container);
    this.map = undefined;
  }
  
  _createButton(className) {
    const el = window.document.createElement('button')
    el.className = className;
    el.addEventListener('click',(e)=>{
		this.map.flyTo({
center: [8.349325060844421, 49.01890053442718],
essential: true // this animation is considered essential with respect to prefers-reduced-motion
});
    },false )
    return el;
  }
}

const myCustomControl = new MyCustomControl();
map.addControl(myCustomControl);

</script>

</body>
</html>